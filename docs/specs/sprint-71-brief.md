# Sprint 71: AuthProvider Refactoring — Implementation Brief

> **Generated:** 2026-02-05
> **Generated By:** Scoping session + architecture audit
> **Spec:** None (refactoring sprint)
> **Status:** Ready for Implementation (skip plan mode)

---

## Why This Sprint

**Current state:** Auth is functionally complete — Firebase Auth (email, Google, Facebook, phone, magic link), 6 user roles, 30 granular permissions, 4 portal layouts. But architecturally fragmented.

**5 Critical Issues Found:**

1. **Silent profile loading failures** — Firestore errors caught but swallowed; components fail silently when `profile?.orgId` is undefined
2. **No Next.js middleware** — Unauthenticated users briefly see protected content during hydration
3. **OrgId not validated** — 30+ scattered `profile?.orgId` defensive checks across hooks
4. **Profile never refetches** — Admin role changes require page reload; multi-device out of sync
5. **Duplicate role mappings** — 3 separate implementations of role→path mapping in 3 files

**CLAUDE.md flags this:** "AuthProvider architecture needs refactoring" is listed under Known Issues / Tech Debt.

---

## Existing Infrastructure

### Core Auth Files (677 lines total)
| File | Lines | Purpose | Issues |
|------|-------|---------|--------|
| `lib/auth.tsx` | 125 | Main AuthProvider + AuthContext | Profile silently fails; no refetch; one-time profile load |
| `lib/contexts/ImpersonationContext.tsx` | 234 | Role impersonation for testing | Unencrypted localStorage; duplicate role mapping |
| `components/auth/AuthGuard.tsx` | 95 | Redirects unauthenticated users | Duplicate role→path mapping |
| `components/auth/RouteGuard.tsx` | 223 | Permission-based route protection | Known bug #7: shows impersonated role in access denied |
| `lib/firebase/config.ts` | 64 | Firebase initialization | Clean, no issues |

### Portal Layouts
| Route | File | Lines | Allowed Roles |
|-------|------|-------|---------------|
| `/dashboard/**` | `app/dashboard/layout.tsx` | 549 | OWNER, PM, EMPLOYEE, CONTRACTOR |
| `/field/**` | `app/field/layout.tsx` | 52 | All except CLIENT |
| `/client/**` | `app/client/layout.tsx` | 47 | CLIENT only |
| `/sub/**` | `app/sub/layout.tsx` | 44 | SUB only |
| `/sign/[token]` | `app/sign/[token]/page.tsx` | — | Public (no auth) |

### Types (in types/index.ts)
| Type | Lines | Notes |
|------|-------|-------|
| UserRole | ~20 | 6 roles: OWNER, PM, EMPLOYEE, CONTRACTOR, SUB, CLIENT |
| UserProfile | ~30-100 | Full user profile with orgId, role, permissions |
| RolePermissions | ~154-277 | 30 permissions across 10 categories |
| ROLE_PERMISSIONS | ~280+ | Static role→permissions matrix |

### Existing Auth Tests
| File | Notes |
|------|-------|
| `__tests__/lib/hooks/useAuth.test.tsx` | Tests auth context — will need updating after refactor |
| `__tests__/lib/security/auth-helpers.test.ts` | Tests auth utilities — likely stable |

---

## What Exists vs What's Missing

### Already Built
- [x] Firebase Auth integration (email, Google, Facebook, phone, magic link)
- [x] 6 user roles with 30 granular permissions
- [x] AuthGuard (redirect unauthenticated)
- [x] RouteGuard (permission-based access)
- [x] ImpersonationContext (role testing/demo)
- [x] 4 portal layouts with role filtering
- [x] Login, register, forgot password pages

### Needs to be Created
- [ ] **`lib/auth/role-utils.ts`** — Single source of truth for role→path mapping (consolidate 3 duplicates)
- [ ] **`middleware.ts`** — Next.js middleware for server-side auth checking
- [ ] **`lib/auth/useAuthenticatedOrg.ts`** — Hook that guarantees orgId exists (replaces 30+ defensive checks)

### Needs Modification
- [ ] **`lib/auth.tsx`** — Add real-time profile sync (onSnapshot instead of one-time getDocs), surface errors
- [ ] **`components/auth/AuthGuard.tsx`** — Use shared role-utils instead of local mapping
- [ ] **`components/auth/RouteGuard.tsx`** — Fix bug #7 (impersonated role in access denied), use shared role-utils
- [ ] **`lib/contexts/ImpersonationContext.tsx`** — Use shared role-utils, fix localStorage security
- [ ] **`app/login/page.tsx`** — Use shared role-utils for redirect paths
- [ ] **`__tests__/lib/hooks/useAuth.test.tsx`** — Update to cover refactored auth

---

## Files to Create

| # | File Path | Purpose | Pattern to Follow |
|---|-----------|---------|-------------------|
| 1 | `lib/auth/role-utils.ts` | Consolidated role→path mapping, role helpers | New — simple utility module |
| 2 | `middleware.ts` | Next.js middleware for server-side auth | Next.js 16 middleware pattern |
| 3 | `lib/hooks/useAuthenticatedOrg.ts` | Hook returning guaranteed orgId or redirecting | See useAuth pattern in lib/auth.tsx |
| 4 | `__tests__/lib/auth/role-utils.test.ts` | Tests for role utilities | See auth-helpers.test.ts |
| 5 | `__tests__/lib/hooks/useAuthenticatedOrg.test.ts` | Tests for org hook | See useAuth.test.tsx |

## Files to Modify

| # | File Path | What Changes | Lines Affected |
|---|-----------|-------------|----------------|
| 1 | `lib/auth.tsx` | Replace one-time getDocs with onSnapshot for profile; add error surfacing; expose profileError state | Lines 60-90 (profile fetch) |
| 2 | `components/auth/AuthGuard.tsx` | Import from role-utils instead of local getDefaultPath | Lines 15-29 (remove duplicate) |
| 3 | `components/auth/RouteGuard.tsx` | Fix bug #7 (show actual role, not impersonated); import from role-utils | Lines 147-149 (bug), 15-29 (remove duplicate) |
| 4 | `lib/contexts/ImpersonationContext.tsx` | Import from role-utils; use sessionStorage instead of localStorage | Lines 218-233 (remove duplicate), line 50 (storage) |
| 5 | `app/login/page.tsx` | Import from role-utils instead of local getRedirectPath | Lines 15-29 (remove duplicate) |
| 6 | `__tests__/lib/hooks/useAuth.test.tsx` | Update for real-time profile + profileError | Depends on auth.tsx changes |

---

## Detailed Changes

### 1. Role Utils (NEW: `lib/auth/role-utils.ts`)

Consolidate the 3 duplicate role→path mappings into one:

```typescript
// Single source of truth
export const ROLE_DEFAULT_PATHS: Record<UserRole, string> = {
  OWNER: '/dashboard',
  PM: '/dashboard',
  EMPLOYEE: '/field',
  CONTRACTOR: '/field',
  SUB: '/sub',
  CLIENT: '/client',
};

export function getDefaultPathForRole(role: UserRole): string;
export function getRolesForPortal(portal: 'dashboard' | 'field' | 'client' | 'sub'): UserRole[];
export function canAccessPortal(role: UserRole, portal: string): boolean;
```

### 2. Real-Time Profile Sync (MODIFY: `lib/auth.tsx`)

Change from:
```typescript
// Current: one-time fetch, errors swallowed
const docSnap = await getDoc(userDocRef);
if (docSnap.exists()) { setProfile(docSnap.data()); }
```

To:
```typescript
// New: real-time sync, errors surfaced
const unsubscribe = onSnapshot(userDocRef,
  (docSnap) => {
    if (docSnap.exists()) setProfile(docSnap.data());
    setProfileLoading(false);
  },
  (error) => {
    setProfileError(error);
    setProfileLoading(false);
  }
);
```

### 3. useAuthenticatedOrg Hook (NEW)

Replace 30+ instances of `const orgId = profile?.orgId; if (!orgId) return;` with:
```typescript
export function useAuthenticatedOrg() {
  const { profile } = useAuth();
  const orgId = profile?.orgId;

  if (!orgId) {
    // Either still loading or user has no org
    return { orgId: null, ready: false } as const;
  }

  return { orgId, profile: profile!, ready: true } as const;
}
```

### 4. Next.js Middleware (NEW: `middleware.ts`)

```typescript
// Server-side auth check using Firebase session cookie
// Prevents flash of protected content during hydration
export function middleware(request: NextRequest) {
  const session = request.cookies.get('__session');
  const { pathname } = request.nextUrl;

  // Public routes
  if (pathname.startsWith('/login') || pathname.startsWith('/sign/')) return;

  // No session → redirect to login
  if (!session) return NextResponse.redirect(new URL('/login', request.url));
}

export const config = {
  matcher: ['/dashboard/:path*', '/field/:path*', '/client/:path*', '/sub/:path*'],
};
```

**Note:** Firebase Auth doesn't natively use cookies for SSR. This middleware checks for a `__session` cookie that must be set client-side after login. This is the standard Firebase + Next.js pattern.

---

## Patterns to Follow

### Auth Utility Pattern
```
Reference: lib/security/auth-helpers.ts
- Pure functions, no side effects
- Fully typed with UserRole/UserProfile types
- Unit testable without mocking
```

### Hook Refactoring Pattern
```
Reference: lib/hooks/useFirestoreCollection.ts
- Real-time via onSnapshot
- Return loading + error states
- Clean up subscriptions in useEffect cleanup
```

### Next.js Middleware Pattern
```
Reference: Next.js 16 docs
- Export middleware function + config with matcher
- Use NextResponse for redirects
- Keep it lightweight (edge runtime)
```

---

## Migration Strategy

This refactoring is designed to be **incremental and non-breaking**:

1. **Phase 1 (role-utils):** Create new file, update imports — no behavior change
2. **Phase 2 (real-time profile):** Add onSnapshot — additive change, existing consumers unaffected
3. **Phase 3 (useAuthenticatedOrg):** New hook, existing code keeps working — adopt gradually
4. **Phase 4 (middleware):** New file, adds server-side check — strictly additive
5. **Phase 5 (cleanup):** Remove old duplicate code — only after new code verified

At no point does existing functionality break. Each phase can be verified independently.

---

## Parallel Work Plan

### Batch 1 — Foundation (No Dependencies)
| Agent | Task | Files |
|-------|------|-------|
| Feature Agent 1 | Create role-utils.ts + tests | `lib/auth/role-utils.ts`, `__tests__/lib/auth/role-utils.test.ts` |
| Feature Agent 2 | Create middleware.ts | `middleware.ts` |
| Feature Agent 3 | Create useAuthenticatedOrg hook + tests | `lib/hooks/useAuthenticatedOrg.ts`, `__tests__/lib/hooks/useAuthenticatedOrg.test.ts` |

### Batch 2 — Integration (Depends on Batch 1)
| Agent | Task | Files |
|-------|------|-------|
| Refactor Agent 1 | Update auth.tsx: real-time profile + error surfacing | `lib/auth.tsx` |
| Refactor Agent 2 | Update AuthGuard + login page to use role-utils | `components/auth/AuthGuard.tsx`, `app/login/page.tsx` |
| Refactor Agent 3 | Update RouteGuard (fix bug #7) + ImpersonationContext to use role-utils | `components/auth/RouteGuard.tsx`, `lib/contexts/ImpersonationContext.tsx` |

### Batch 3 — Verification
| Agent | Task | Files |
|-------|------|-------|
| Test Agent | Update useAuth.test.tsx, run full test suite | `__tests__/lib/hooks/useAuth.test.tsx` |
| Bash Agent | `npx tsc --noEmit` + verify all portals still work | — |

---

## Acceptance Criteria

- [ ] `lib/auth/role-utils.ts` created with consolidated role→path mapping
- [ ] All 3 duplicate role mappings replaced with imports from role-utils
- [ ] Profile loads via onSnapshot (real-time sync) instead of one-time getDocs
- [ ] `profileError` exposed from AuthContext — components can display auth errors
- [ ] `useAuthenticatedOrg` hook created and tested
- [ ] Bug #7 fixed: RouteGuard access denied page shows actual role, not impersonated
- [ ] ImpersonationContext uses sessionStorage instead of localStorage
- [ ] `middleware.ts` created — server-side auth check for protected routes
- [ ] All existing auth tests pass (updated as needed)
- [ ] New tests for role-utils and useAuthenticatedOrg
- [ ] No TypeScript errors — `npx tsc --noEmit` passes
- [ ] All 4 portals (dashboard, field, client, sub) still function correctly

---

## Risk Assessment

| Risk | Likelihood | Mitigation |
|------|-----------|------------|
| Breaking existing auth flow | LOW | Incremental changes, each phase independently verifiable |
| Middleware cookie not set | MEDIUM | Must add cookie-setting logic in login flow — document clearly |
| onSnapshot performance | LOW | Single doc listener, minimal overhead |
| ImpersonationContext sessionStorage breaks dev workflow | LOW | sessionStorage clears on tab close — acceptable for testing tool |

---

## Decision Log

| Decision | Rationale | Alternative Considered |
|----------|-----------|----------------------|
| onSnapshot for profile (not polling) | Real-time, built into Firebase, minimal overhead | Polling every 30s — wasteful, delayed |
| sessionStorage for impersonation (not encrypted localStorage) | Impersonation is dev-only tool; sessionStorage auto-clears | Encrypted localStorage — over-engineered for dev tool |
| Middleware with cookie check (not token verification) | Edge runtime can't run Firebase Admin SDK; cookie check is standard pattern | Full token verification — requires Node.js runtime, defeats edge middleware purpose |
| useAuthenticatedOrg as opt-in hook (not replacing useAuth) | Non-breaking, gradual adoption; existing code keeps working | Replace useAuth entirely — too risky for one sprint |
| Don't migrate all 30+ orgId checks this sprint | Refactor scope creep; the hook exists for future adoption | Migrate all consumers — too many files, too much risk |

---

## Estimated Token Budget

| Phase | Tokens | Notes |
|-------|--------|-------|
| Reading this brief | ~5k | Skip plan mode entirely |
| Batch 1 (new files) | ~30-40k | 3 parallel agents |
| Batch 2 (refactoring) | ~40-50k | 3 parallel agents |
| Batch 3 (verification) | ~15-20k | Tests + tsc |
| **Total** | **~90-115k** | |
