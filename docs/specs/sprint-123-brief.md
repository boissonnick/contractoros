# Sprint 123: Unit Test Coverage Push (1,502 → 2,000+) — Implementation Brief

> **Generated:** 2026-02-06
> **Generated By:** Roadmap Planning Session (Phase 18: Production Hardening)
> **Status:** Ready for Implementation (skip plan mode)
> **Priority:** P1 | **Hours:** 10-14

---

## Overview

Cover remaining high-value hooks, utilities, and new code from Sprints 106-120. Target: 500+ new tests bringing total from ~1,502 to 2,000+. Test-only sprint — no source code modifications.

---

## Existing Test Coverage (42 files, 1,502 tests)

32 hook test files exist covering: useActivityLog, useAuthenticatedOrg, useBids, useChangeOrders, useClients, useCompanyStats, useDailyLogs, useEquipment, useExpenses, useGoogleBusiness, useInvoices, useJobCosting, useLeads, useMaterials, useMessages, useNotifications, usePagination, usePayments, usePayroll, usePhases, usePunchList, useRFIs, useReviews, useSafety, useScheduleEvents, useSelections, useSignatureRequests, useSubcontractorInvoices, useSubcontractors, useSubmittals, useTasks, useTimeEntries.

5 utility test files: formatters, timestamp-converter, auto-number, ganttTransform, tax-calculator.

---

## Hooks WITHOUT Tests (Need Coverage)

### High Priority (Core Business Logic)
| Hook | Est. Tests | Pattern |
|------|-----------|---------|
| useEstimates | 25-30 | useExpenses.test.ts |
| useRecurringInvoices | 20-25 | useInvoices.test.ts |
| useTimesheets | 15-20 | usePayroll.test.ts |
| useProjects | 20-25 | useClients.test.ts |
| useAccountingConnection | 20-25 | useCompanyStats.test.ts |

### Medium Priority
| Hook | Est. Tests | Pattern |
|------|-----------|---------|
| useAvailability | 12-15 | useTimeEntries.test.ts |
| useDocuments | 12-15 | useMaterials.test.ts |
| useSchedule | 15-18 | useScheduleEvents.test.ts |
| useIssues | 12-15 | useRFIs.test.ts |
| useMaterialRequests | 12-15 | useMaterials.test.ts |
| useFirestoreCollection | 12-15 | useClients.test.ts |
| useFirestoreCrud | 12-15 | useExpenses.test.ts |

### Lower Priority
| Hook | Est. Tests | Pattern |
|------|-----------|---------|
| useWarranties | 10-12 | useMaterials.test.ts |
| useTools | 10-12 | useEquipment.test.ts |
| usePermits | 10-12 | useSubmittals.test.ts |
| useServiceTickets | 10-12 | useRFIs.test.ts |
| useScopes | 10-12 | usePhases.test.ts |
| useCloseoutChecklist | 8-10 | usePunchList.test.ts |
| useCustomReports | 10-12 | useReviews.test.ts |
| useEmailTemplates | 8-10 | useReviews.test.ts |

### Utility/Integration Tests
| Module | Est. Tests |
|--------|-----------|
| Logger utility (if Sprint 113 done) | 15-20 |
| QBO sync expenses | 15-20 |

---

## Test Pattern (Reference: useExpenses.test.ts)

Each hook test file covers:
1. Initial state (loading, empty data)
2. Data fetching via onSnapshot (success + error)
3. CRUD operations (create, update, delete)
4. Error handling (network errors, permission errors)
5. Edge cases (null orgId, unmount cleanup, empty data)
6. Business logic specific to the hook

Standard mocks: firebase/firestore, @/lib/firebase/config, @/lib/auth, @/components/ui/Toast, @/lib/firebase/timestamp-converter.

---

## Files to Create (22 test files)

| # | File | Hook Tested | Est. Tests |
|---|------|------------|-----------|
| 1 | __tests__/lib/hooks/useEstimates.test.ts | useEstimates | 25-30 |
| 2 | __tests__/lib/hooks/useRecurringInvoices.test.ts | useRecurringInvoices | 20-25 |
| 3 | __tests__/lib/hooks/useTimesheets.test.ts | useTimesheets | 15-20 |
| 4 | __tests__/lib/hooks/useProjects.test.ts | useProjects | 20-25 |
| 5 | __tests__/lib/hooks/useAccountingConnection.test.ts | useAccountingConnection | 20-25 |
| 6 | __tests__/lib/hooks/useAvailability.test.ts | useAvailability | 12-15 |
| 7 | __tests__/lib/hooks/useDocuments.test.ts | useDocuments | 12-15 |
| 8 | __tests__/lib/hooks/useSchedule.test.ts | useSchedule | 15-18 |
| 9 | __tests__/lib/hooks/useIssues.test.ts | useIssues | 12-15 |
| 10 | __tests__/lib/hooks/useMaterialRequests.test.ts | useMaterialRequests | 12-15 |
| 11 | __tests__/lib/hooks/useFirestoreCollection.test.ts | useFirestoreCollection | 12-15 |
| 12 | __tests__/lib/hooks/useFirestoreCrud.test.ts | useFirestoreCrud | 12-15 |
| 13 | __tests__/lib/hooks/useWarranties.test.ts | useWarranties | 10-12 |
| 14 | __tests__/lib/hooks/useTools.test.ts | useTools | 10-12 |
| 15 | __tests__/lib/hooks/usePermits.test.ts | usePermits | 10-12 |
| 16 | __tests__/lib/hooks/useServiceTickets.test.ts | useServiceTickets | 10-12 |
| 17 | __tests__/lib/hooks/useScopes.test.ts | useScopes | 10-12 |
| 18 | __tests__/lib/hooks/useCloseoutChecklist.test.ts | useCloseoutChecklist | 8-10 |
| 19 | __tests__/lib/hooks/useCustomReports.test.ts | useCustomReports | 10-12 |
| 20 | __tests__/lib/hooks/useEmailTemplates.test.ts | useEmailTemplates | 8-10 |
| 21 | __tests__/lib/integrations/qbo-sync-expenses.test.ts | QBO sync | 15-20 |
| 22 | __tests__/lib/utils/logger.test.ts | Logger (if created) | 15-20 |

---

## Parallel Work Plan

### Batch 1: 5 Agents in Parallel (Separate Files)
| Agent | Hooks to Test | Files | Est. Tests |
|-------|--------------|-------|-----------|
| Agent 1 | useEstimates, useRecurringInvoices, useDocuments | 3 files | ~65 |
| Agent 2 | useTimesheets, useAvailability, useSchedule, usePermits | 4 files | ~55 |
| Agent 3 | useProjects, useIssues, useMaterialRequests, useServiceTickets | 4 files | ~55 |
| Agent 4 | useFirestoreCollection, useFirestoreCrud, useScopes, useCloseoutChecklist, useCustomReports, useEmailTemplates | 6 files | ~65 |
| Agent 5 | useAccountingConnection, useWarranties, useTools, QBO sync, logger | 5 files | ~75 |

### Batch 2: Verification
| Task | Command |
|------|---------|
| Run full suite | npm test -- --passWithNoTests |
| Count total | npm test -- --verbose 2>&1 \| grep "Tests:" |
| Check OOM | Monitor memory during full run |

---

## Acceptance Criteria

- [ ] Total test count: 1,502 → 2,000+ (498+ new tests)
- [ ] All new tests passing
- [ ] All existing tests still passing
- [ ] No OOM errors during full suite
- [ ] 22 new test files created
- [ ] npx tsc --noEmit passes
- [ ] Test suite completes in under 5 minutes

---

## Estimated Token Budget: ~215-250k (test-only, highly parallel)
