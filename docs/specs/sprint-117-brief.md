# Sprint 117: Error Handling, Boundaries & Loading States — Implementation Brief

> **Generated:** 2026-02-06
> **Generated By:** Roadmap Planning Session
> **Status:** Ready for Implementation (skip plan mode)
> **Priority:** P2 | **Hours:** 6-8

---

## Overview

Comprehensive error resilience across all portals. Add SectionErrorBoundary wraps to all dashboard widgets, audit all catch blocks in hooks, add skeleton loading to 15 highest-traffic pages, and create a Firestore retry utility.

---

## Existing Infrastructure

### Components
| Component | File | Notes |
|-----------|------|-------|
| SectionErrorBoundary | components/ui/SectionErrorBoundary.tsx | Built Sprint 61, class component with retry, accepts sectionName + fallback |
| Skeleton | components/ui/Skeleton.tsx | 12 variants: Card, Table, Dashboard, List, Schedule, Reports, ProjectCard, TaskCard, KanbanColumn, SubcontractorsList, SubcontractorDetail, BidsList |
| OfflineProvider | components/offline/OfflineProvider.tsx | Provides isOnline, syncNow, queueOperation |
| OfflineBanner | components/offline/OfflineBanner.tsx | Shows offline state |
| Toast | components/ui/Toast.tsx | Use for error notifications |

### Hooks (85 total in lib/hooks/)
All need catch block audit — many silently swallow errors with console.error only.

### Pages (15 highest-traffic dashboard pages)
All need skeleton loading states where `loading` returns plain spinner or no placeholder.

---

## What Exists vs What's Missing

### Already Built
- [x] SectionErrorBoundary with retry button
- [x] 12 Skeleton variants
- [x] Offline awareness (OfflineProvider + OfflineBanner)
- [x] Toast system for user-facing error notifications

### Needs to be Created
- [ ] `lib/utils/firestore-retry.ts` — Exponential backoff for Firestore operations

### Needs Modification
- [ ] All dashboard pages — Wrap widget sections in SectionErrorBoundary
- [ ] 85 hooks — Audit catch blocks, add toast errors instead of silent console.error
- [ ] 15 pages — Add Skeleton loading states

---

## Files to Create

| # | File Path | Purpose | Pattern |
|---|-----------|---------|---------|
| 1 | lib/utils/firestore-retry.ts | Exponential backoff: 3 retries, 1s base, 10s max, jitter | Standard retry pattern |

## Files to Modify

| # | File Path | What Changes |
|---|-----------|-------------|
| 1 | app/dashboard/page.tsx | Wrap widgets in SectionErrorBoundary, use SkeletonDashboard |
| 2 | app/dashboard/projects/page.tsx | SkeletonProjectCard grid, SectionErrorBoundary |
| 3 | app/dashboard/clients/page.tsx | SkeletonList, SectionErrorBoundary |
| 4 | app/dashboard/invoices/page.tsx | SkeletonTable |
| 5 | app/dashboard/expenses/page.tsx | SkeletonList |
| 6 | app/dashboard/team/page.tsx | SkeletonList |
| 7 | app/dashboard/messages/page.tsx | SkeletonList |
| 8 | app/dashboard/estimates/page.tsx | SkeletonList |
| 9 | app/dashboard/equipment/page.tsx | SkeletonList |
| 10 | app/dashboard/materials/page.tsx | SkeletonList |
| 11 | app/dashboard/payroll/page.tsx | SkeletonTable |
| 12 | app/dashboard/timesheets/page.tsx | SkeletonTable |
| 13 | app/dashboard/tasks/page.tsx | SkeletonKanbanColumn |
| 14 | app/dashboard/schedule/page.tsx | Verify SkeletonSchedule, add SectionErrorBoundary |
| 15 | app/dashboard/settings/page.tsx | Skeleton loading |
| 16-100 | lib/hooks/use*.ts (85 hooks) | Audit catch blocks: toast + error state |

---

## Patterns to Follow

### SectionErrorBoundary Wrapping
```tsx
import { SectionErrorBoundary } from '@/components/ui/SectionErrorBoundary';

<SectionErrorBoundary sectionName="Recent Projects">
  <RecentProjectsWidget />
</SectionErrorBoundary>
```

### Hook Error Handling (AFTER)
```tsx
} catch (error) {
  console.error('Error loading clients:', error);
  toast.error('Failed to load clients. Please try again.');
  setError(error instanceof Error ? error : new Error('Unknown error'));
}
```

### Skeleton Loading
```tsx
import { SkeletonList } from '@/components/ui/Skeleton';
if (loading) {
  return (<><PageHeader title="Clients" /><SkeletonList count={8} /></>);
}
```

---

## Parallel Work Plan

### Batch 1 (All Independent)
| Agent | Task | Files | Est. Tokens |
|-------|------|-------|-------------|
| Agent 1 | SectionErrorBoundary wraps on dashboard pages | app/dashboard/ pages | ~25k |
| Agent 2 | Catch block audit hooks A-L (~40 hooks) | lib/hooks/useA* through useL* | ~30k |
| Agent 3 | Catch block audit hooks M-Z (~45 hooks) | lib/hooks/useM* through useW* | ~30k |
| Agent 4 | Skeleton loading on 15 pages | All dashboard pages | ~25k |

### Batch 2 (After Batch 1)
| Agent | Task | Files | Est. Tokens |
|-------|------|-------|-------------|
| Agent 5 | Create firestore-retry.ts + integrate into 5 critical hooks | lib/utils/firestore-retry.ts + top 5 hooks | ~15k |

---

## Acceptance Criteria

- [ ] All dashboard widget sections wrapped in SectionErrorBoundary
- [ ] All 85 hooks audited — no silent catch blocks swallowing errors
- [ ] 15 highest-traffic pages show skeleton loading
- [ ] firestore-retry.ts created (3 retries, 1s base, 10s max, jitter)
- [ ] Retry logic in 5 critical hooks (useProjects, useClients, useInvoices, useExpenses, useTasks)
- [ ] npx tsc --noEmit passes

---

## Estimated Token Budget: ~140k
