# Sprint 125: Stripe Connect — Online Payments for Clients — Implementation Brief

> **Generated:** 2026-02-06
> **Generated By:** Roadmap Planning Session (Phase 19: Integrations)
> **Status:** Ready for Implementation (skip plan mode)
> **Priority:** P0 | **Hours:** 10-14

---

## Overview

Enable real client payments. GCs connect their Stripe account via Express Connect, clients pay invoices online via the existing /pay/[token] page enhanced with destination charges and partial payment support.

---

## Existing Infrastructure

### Already Built (Extensive Stripe Foundation)
| Component | File | Notes |
|-----------|------|-------|
| StripePayment type | types/index.ts lines 3771-3820 | Full payment model: amount, status, paymentIntentId |
| PaymentLink type | types/index.ts lines 3854-3870 | Token-based payment links |
| usePayments hook | lib/hooks/usePayments.ts | Payment intents, links, refunds, stats |
| Payment page | app/pay/[token]/page.tsx | Public payment page with PaymentForm |
| Payment API | app/api/payments/route.ts | Create payment intents |
| Stripe client | lib/payments/stripeClient.ts | SDK init, publishable key, webhook secret |
| PaymentForm | components/payments/PaymentForm.tsx | Stripe Elements card input |
| Payment receipt | functions/src/email/automatedEmails.ts | Email on payment success |

### What's Missing
- [ ] Stripe Connect Express account onboarding for GCs
- [ ] Destination charges routing payments through GC Connect account
- [ ] Connect account status tracking in Firestore
- [ ] Payout dashboard for GC (Stripe balance, upcoming payouts)
- [ ] Partial payment support on pay page
- [ ] Connect webhook handler (account.updated, payout events)

---

## Files to Create

| # | File Path | Purpose | Pattern |
|---|-----------|---------|---------|
| 1 | lib/integrations/stripe/connect.ts | Connect account management | QBO oauth.ts pattern |
| 2 | app/api/integrations/stripe/connect/route.ts | Create Express account + onboarding URL | QBO connect/route.ts |
| 3 | app/api/integrations/stripe/connect/callback/route.ts | Handle return from onboarding | QBO callback/route.ts |
| 4 | app/api/integrations/stripe/connect/status/route.ts | Check account status | QBO status/route.ts |
| 5 | app/api/integrations/stripe/connect/disconnect/route.ts | Deauthorize | QBO disconnect/route.ts |
| 6 | app/api/integrations/stripe/webhook/route.ts | Handle Stripe webhooks | QBO webhook/route.ts |
| 7 | app/api/integrations/stripe/payouts/route.ts | List payouts | New |
| 8 | app/dashboard/settings/integrations/stripe/page.tsx | Connect settings UI | QBO settings page |
| 9 | components/settings/StripeConnectStatus.tsx | Account status card | QBOSyncStatus pattern |
| 10 | components/settings/StripePayoutDashboard.tsx | Payout history | Dashboard card |
| 11 | lib/hooks/useStripeConnect.ts | Connect status hook | useAccountingConnection pattern |

## Files to Modify

| # | File Path | What Changes |
|---|-----------|-------------|
| 1 | types/index.ts | Add StripeConnectAccount interface |
| 2 | lib/payments/stripeClient.ts | Add destination charge helpers |
| 3 | app/api/payments/route.ts | Use destination charges with application_fee |
| 4 | app/pay/[token]/page.tsx | Add partial payment amount input |
| 5 | firestore.rules | Add stripeConnect, stripePayouts collections |

---

## Firestore Rules Needed

```javascript
match /organizations/{orgId}/stripeConnect/{docId} {
  allow read, write: if isSameOrg(orgId);
}
match /organizations/{orgId}/stripePayouts/{docId} {
  allow read: if isSameOrg(orgId);
  allow write: if false; // Webhook handler only
}
```

---

## Parallel Work Plan

### Batch 1 (No Dependencies)
| Agent | Task | Est. Tokens |
|-------|------|-------------|
| Agent 1 | Types + Connect lib + hook | ~20k |
| Agent 2 | Firestore rules + indexes | ~10k |

### Batch 2 (Depends on Batch 1)
| Agent | Task | Est. Tokens |
|-------|------|-------------|
| Agent 1 | Connect API routes (connect, callback, status, disconnect) | ~30k |
| Agent 2 | Webhook handler | ~20k |
| Agent 3 | Payouts API route | ~15k |

### Batch 3 (Depends on Batch 2)
| Agent | Task | Est. Tokens |
|-------|------|-------------|
| Agent 1 | Settings page + status component + payout dashboard | ~35k |
| Agent 2 | Modify payment flow for destination charges + partial payments | ~25k |

---

## Environment Variables Needed

| Variable | Purpose | Status |
|----------|---------|--------|
| STRIPE_SECRET_KEY | Platform key | Already exists |
| NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY | Client-side | Already exists |
| STRIPE_WEBHOOK_SECRET | Verify webhooks | Already exists |
| STRIPE_CONNECT_WEBHOOK_SECRET | Connect webhooks | NEW |
| STRIPE_PLATFORM_FEE_PERCENT | Fee % (default: 2.9) | NEW |
| STRIPE_PLATFORM_FEE_FIXED | Fee fixed cents (default: 30) | NEW |

---

## Acceptance Criteria

- [ ] GC can initiate Stripe Connect onboarding from Settings
- [ ] After onboarding, account shows charges_enabled and payouts_enabled
- [ ] Client payments route through GC Connect account as destination charges
- [ ] Platform fee deducted and sent to platform
- [ ] Webhook updates invoice status on payment success
- [ ] GC can view payout history
- [ ] Clients can enter partial payment amount
- [ ] npx tsc --noEmit passes

---

## Estimated Token Budget: ~205k
