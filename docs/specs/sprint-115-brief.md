# Sprint 115: Messaging & Communication Overhaul — Implementation Brief

> **Generated:** 2026-02-06
> **Generated By:** Roadmap Planning Session
> **Status:** Ready for Implementation (skip plan mode)
> **Priority:** P2 | **Hours:** 8-10

---

## Overview

Build a unified inbox, add read receipts, message templates, and improve the messaging UX across all portals. Currently messages are basic — this sprint makes them production-quality.

---

## Existing Infrastructure

### Hooks
| Hook | File | Notes |
|------|------|-------|
| useMessages | lib/hooks/useMessages.ts | CRUD + real-time, channels, send/receive |
| useSms | lib/hooks/useSms.ts | SMS sending via Twilio |
| useNotifications | lib/hooks/useNotifications.ts | In-app notification system |

### Pages
| Route | File | Notes |
|-------|------|-------|
| /dashboard/messages | app/dashboard/messages/page.tsx | Channel list + thread view |
| /client/messages | app/client/messages/page.tsx | Client message view |

### Components
| Component | File | Notes |
|-----------|------|-------|
| MessageThread | components/messages/MessageThread.tsx | Message display |
| MessageComposer | components/messages/MessageComposer.tsx | Message input |
| SmsTemplatesTab | components/messages/SmsTemplatesTab.tsx | SMS template management |

---

## What Exists vs What's Missing

### Already Built
- [x] Message channels with real-time updates
- [x] Basic send/receive with file attachments
- [x] SMS templates for bulk messaging

### Needs to be Created
- [ ] Unified inbox: All messages (internal, client, sub) in one view
- [ ] Read receipts: Track when messages are read per user
- [ ] Message templates: Predefined templates for common communications
- [ ] @mentions: Tag team members in messages
- [ ] Message search: Full-text search across all channels

### Needs Modification
- [ ] useMessages.ts — Add readAt tracking, search, unified query
- [ ] MessageThread.tsx — Show read receipts, @mention highlighting
- [ ] MessageComposer.tsx — Template picker, @mention autocomplete

---

## Files to Create

| # | File Path | Purpose | Pattern to Follow |
|---|-----------|---------|-------------------|
| 1 | components/messages/UnifiedInbox.tsx | All channels in one sortable list | DataTable pattern |
| 2 | components/messages/ReadReceipt.tsx | Read receipt indicators | Small inline component |
| 3 | components/messages/MessageTemplates.tsx | Template picker modal | FormModal pattern |
| 4 | components/messages/MentionAutocomplete.tsx | @mention team member picker | Dropdown autocomplete |
| 5 | lib/hooks/useMessageTemplates.ts | CRUD for message templates | useEmailTemplates pattern |
| 6 | lib/hooks/useMessageSearch.ts | Full-text message search | useFirestoreCollection pattern |

## Files to Modify

| # | File Path | What Changes |
|---|-----------|-------------|
| 1 | types/index.ts | Add MessageTemplate, ReadReceipt types |
| 2 | lib/hooks/useMessages.ts | Add markAsRead, getUnreadCount, search |
| 3 | components/messages/MessageThread.tsx | Read receipt display, @mention rendering |
| 4 | components/messages/MessageComposer.tsx | Template picker button, @mention input |
| 5 | app/dashboard/messages/page.tsx | Unified inbox view toggle |

---

## Parallel Work Plan

### Batch 1 (No Dependencies)
| Agent | Task | Files | Est. Tokens |
|-------|------|-------|-------------|
| Agent 1 | Unified inbox + read receipts | UnifiedInbox.tsx, ReadReceipt.tsx, useMessages.ts modifications | ~30k |
| Agent 2 | Message templates + template hook | MessageTemplates.tsx, useMessageTemplates.ts | ~20k |
| Agent 3 | @mentions + search | MentionAutocomplete.tsx, useMessageSearch.ts | ~25k |

### Batch 2 (Integration)
| Agent | Task | Files | Est. Tokens |
|-------|------|-------|-------------|
| Agent 4 | Wire into messages page, add Firestore rules/indexes | messages/page.tsx, firestore.rules | ~20k |

---

## Acceptance Criteria

- [ ] Unified inbox shows all channels sorted by last message
- [ ] Read receipts show who has read each message
- [ ] Message templates can be created, edited, and inserted
- [ ] @mentions autocomplete team members and highlight in thread
- [ ] Message search returns results across all channels
- [ ] npx tsc --noEmit passes

---

## Estimated Token Budget: ~95k
