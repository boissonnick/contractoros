# Sprint 70: Unit Testing Expansion — Implementation Brief

> **Generated:** 2026-02-05
> **Generated By:** Scoping session
> **Spec:** None (infrastructure/quality sprint)
> **Status:** Ready for Implementation (skip plan mode)

---

## Why This Sprint

**Current state:** 9 test files exist covering 5 hooks + 4 utility modules. Jest 30 + React Testing Library fully configured. 60% coverage thresholds set but not enforced in CI.

**The gap:** 95 hooks total, only 5 tested. 18 Zod validation schemas with 0 tests. Key utility modules (tax-calculator, auto-number, ganttTransform) untested. Financial calculation correctness relies entirely on manual E2E testing.

**Strategic value:** Every sprint adds more hooks and business logic. Testing now prevents regression as features compound. Financial calculations (tax, payroll, job costing) have legal/business implications if wrong.

---

## Existing Infrastructure

### Test Configuration (Already Working)
| File | Purpose | Notes |
|------|---------|-------|
| jest.config.js | Jest config for Next.js + TS | Uses `next/jest`, jsdom, @/ alias |
| jest.setup.js | Setup file | Firebase mocks, RTL matchers |
| __tests__/utils/testing-helpers.tsx | Test utilities | Mock auth, mock data factories |

### Test Dependencies (Already Installed)
| Package | Version | Notes |
|---------|---------|-------|
| jest | 30.2.0 | Test runner |
| jest-environment-jsdom | 30.2.0 | Browser environment |
| @testing-library/react | 16.3.2 | Component/hook rendering |
| @testing-library/jest-dom | 6.9.1 | DOM matchers |
| @testing-library/user-event | 14.6.1 | User interaction simulation |
| ts-jest | 29.4.6 | TypeScript transform |

### NPM Scripts (Already Configured)
```
npm test          — Run tests once
npm run test:watch — Watch mode
npm run test:coverage — Generate coverage report
```

### Existing Test Files (9 files, reference patterns)
| Test File | Lines | What It Tests | Pattern Quality |
|-----------|-------|---------------|-----------------|
| `__tests__/lib/hooks/useClients.test.ts` | 1,044 | CRUD, filtering, search | **Best example** — follow this |
| `__tests__/lib/hooks/useProjects.test.tsx` | ~200 | Project hook | Good |
| `__tests__/lib/hooks/useTimeEntries.test.ts` | ~200 | Time tracking | Good |
| `__tests__/lib/hooks/useInvoices.test.ts` | ~200 | Invoice CRUD | Good |
| `__tests__/lib/hooks/useAuth.test.tsx` | ~150 | Auth context | Good |
| `__tests__/lib/utils/formatters.test.ts` | 376 | 10 formatter functions | **Comprehensive** |
| `__tests__/lib/utils/timestamp-converter.test.ts` | ~100 | Timestamp conversion | Good |
| `__tests__/lib/security/auth-helpers.test.ts` | ~100 | Auth utilities | Good |
| `__tests__/lib/security/rate-limiter.test.ts` | ~100 | Rate limiting | Good |

---

## What Exists vs What's Missing

### Already Built
- [x] Jest + RTL fully configured and working
- [x] Firebase mocking patterns established
- [x] Test data factories (mock users, orgs, projects, clients, invoices)
- [x] 5 hook tests with comprehensive patterns
- [x] 4 utility test files
- [x] Coverage thresholds (60%) configured

### Needs to be Created
- [ ] **Validation schema tests** — 18 Zod schemas, 0 tested
- [ ] **Tax calculator tests** — Financial correctness, 200 lines untested
- [ ] **Auto-number tests** — Invoice/estimate numbering, 244 lines untested
- [ ] **Gantt transform tests** — Data transformation, 79 lines untested
- [ ] **Core hook tests** — useExpenses, useBids, useChangeOrders, usePayroll, useTasks, useDailyLogs, useSubcontractors, usePagination
- [ ] **Financial hook tests** — useJobCosting, useCompanyStats (new from Sprint 67)

---

## Files to Create

| # | File Path | Purpose | Pattern to Follow |
|---|-----------|---------|-------------------|
| 1 | `__tests__/lib/validations/index.test.ts` | Test all 18 Zod schemas | New — straightforward schema.parse() / schema.safeParse() |
| 2 | `__tests__/lib/utils/tax-calculator.test.ts` | Test tax calculation functions | See formatters.test.ts |
| 3 | `__tests__/lib/utils/auto-number.test.ts` | Test auto-numbering logic | See formatters.test.ts |
| 4 | `__tests__/lib/utils/ganttTransform.test.ts` | Test Gantt data transforms | See formatters.test.ts |
| 5 | `__tests__/lib/hooks/useExpenses.test.ts` | Test expense CRUD + approval | See useClients.test.ts |
| 6 | `__tests__/lib/hooks/useBids.test.ts` | Test bid lifecycle | See useClients.test.ts |
| 7 | `__tests__/lib/hooks/useChangeOrders.test.ts` | Test change order logic | See useClients.test.ts |
| 8 | `__tests__/lib/hooks/useTasks.test.ts` | Test task CRUD + status transitions | See useClients.test.ts |
| 9 | `__tests__/lib/hooks/usePayroll.test.ts` | Test payroll calculations | See useClients.test.ts |
| 10 | `__tests__/lib/hooks/useDailyLogs.test.ts` | Test daily log CRUD | See useClients.test.ts |
| 11 | `__tests__/lib/hooks/useSubcontractors.test.ts` | Test subcontractor management | See useClients.test.ts |
| 12 | `__tests__/lib/hooks/usePagination.test.ts` | Test cursor-based pagination | See useClients.test.ts |
| 13 | `__tests__/lib/hooks/useJobCosting.test.ts` | Test job costing calculations | See useClients.test.ts |
| 14 | `__tests__/lib/hooks/useCompanyStats.test.ts` | Test org-wide financial aggregation | See useClients.test.ts |

## Files to Modify

| # | File Path | What Changes |
|---|-----------|-------------|
| — | No modifications needed | All new test files |

---

## Patterns to Follow

### Validation Schema Test Pattern
```typescript
// New pattern for this sprint
import { loginSchema, registerSchema } from '@/lib/validations';

describe('loginSchema', () => {
  it('accepts valid input', () => {
    const result = loginSchema.safeParse({ email: 'test@test.com', password: 'password123' });
    expect(result.success).toBe(true);
  });

  it('rejects invalid email', () => {
    const result = loginSchema.safeParse({ email: 'not-an-email', password: 'password123' });
    expect(result.success).toBe(false);
  });

  it('rejects short password', () => {
    const result = loginSchema.safeParse({ email: 'test@test.com', password: '12345' });
    expect(result.success).toBe(false);
  });
});
```

### Utility Test Pattern
```
Reference: __tests__/lib/utils/formatters.test.ts (376 lines)
- Describe block per function
- Test normal cases, edge cases, error cases
- Use table-driven tests for similar inputs
```

### Hook Test Pattern
```
Reference: __tests__/lib/hooks/useClients.test.ts (1,044 lines)
- Mock firebase/firestore module
- Mock onSnapshot to return test data
- Use renderHook() + waitFor() for async
- Test CRUD operations, filtering, error states
- Test loading states
```

---

## Parallel Work Plan

### Batch 1 — Utilities & Validations (No Dependencies)
| Agent | Task | Files | Est. Lines |
|-------|------|-------|-----------|
| Test Agent 1 | Write validation schema tests (18 schemas) | `__tests__/lib/validations/index.test.ts` | ~400 |
| Test Agent 2 | Write tax-calculator tests | `__tests__/lib/utils/tax-calculator.test.ts` | ~250 |
| Test Agent 3 | Write auto-number + ganttTransform tests | 2 test files | ~200 |

### Batch 2 — Financial Hooks (No Dependencies Between Agents)
| Agent | Task | Files | Est. Lines |
|-------|------|-------|-----------|
| Test Agent 1 | Write useExpenses + usePayroll tests | 2 test files | ~600 |
| Test Agent 2 | Write useJobCosting + useCompanyStats tests | 2 test files | ~500 |
| Test Agent 3 | Write useBids + useChangeOrders tests | 2 test files | ~500 |

### Batch 3 — Remaining Hooks
| Agent | Task | Files | Est. Lines |
|-------|------|-------|-----------|
| Test Agent 1 | Write useTasks + useDailyLogs tests | 2 test files | ~500 |
| Test Agent 2 | Write useSubcontractors + usePagination tests | 2 test files | ~400 |

### Batch 4 — Validation & Coverage
| Agent | Task | Files |
|-------|------|-------|
| Bash Agent | Run full test suite, verify all pass, check coverage % | — |

---

## Acceptance Criteria

- [ ] All 14 new test files created and passing
- [ ] 18 Zod validation schemas tested (valid + invalid inputs)
- [ ] Tax calculator: all functions tested with edge cases (zero, negative, multi-level)
- [ ] Auto-number: sequence generation, prefix formatting tested
- [ ] Gantt transform: data transformation correctness tested
- [ ] 10 hook tests: CRUD operations, loading states, error handling
- [ ] Financial hooks (useJobCosting, useCompanyStats): calculation accuracy tested
- [ ] `npm test` passes with 0 failures
- [ ] Coverage report generated — target: 60%+ on tested modules
- [ ] No TypeScript errors — `npx tsc --noEmit` passes

---

## Decision Log

| Decision | Rationale | Alternative Considered |
|----------|-----------|----------------------|
| Jest (not Vitest) | Already installed and configured with 9 working tests | Vitest would require migration of existing tests |
| Test hooks via renderHook | Established pattern in useClients.test.ts | Direct function testing — doesn't test React integration |
| Focus on business logic hooks, not UI hooks | Financial/data hooks have highest correctness risk | Test all 95 hooks — too broad for one sprint |
| Skip component tests this sprint | Hook tests cover business logic; components tested via E2E | Component unit tests — deferred to future sprint |
| 60% coverage threshold (existing) | Already configured, pragmatic target | 80% — too aggressive for initial push |

---

## Estimated Token Budget

| Phase | Tokens | Notes |
|-------|--------|-------|
| Reading this brief | ~5k | Skip plan mode entirely |
| Batch 1 (validations + utils) | ~40-50k | 3 parallel agents |
| Batch 2 (financial hooks) | ~50-60k | 3 parallel agents |
| Batch 3 (remaining hooks) | ~30-40k | 2 parallel agents |
| Batch 4 (run + verify) | ~10k | 1 agent |
| **Total** | **~135-165k** | |
