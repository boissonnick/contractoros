# Sprint 114: Payroll & Team Management Polish — Implementation Brief

> **Generated:** 2026-02-06
> **Generated By:** Roadmap Planning Session
> **Status:** Ready for Implementation (skip plan mode)
> **Priority:** P1 | **Hours:** 8-10

---

## Overview

Enhance payroll with overtime (OT) calculations, PTO/vacation tracking, and certification/license management for team members. This sprint polishes the existing payroll and team systems for production readiness.

---

## Existing Infrastructure

### Types
| Type/Interface | File | Lines | Notes |
|---------------|------|-------|-------|
| PayrollRun | types/index.ts | 1041-1075 | Full payroll run with entries, status, period |
| PayrollEntry | types/index.ts | ~1076-1100 | Per-employee: hours, rate, overtime, deductions |
| TeamMember (UserProfile) | types/index.ts | 1-50 | displayName, role, hourlyRate, certifications |
| TimeEntry | types/index.ts | ~1041-1070 | clockIn, clockOut, totalHours, projectId |

### Hooks
| Hook | File | Pattern | Notes |
|------|------|---------|-------|
| usePayroll | lib/hooks/usePayroll.ts | CRUD + real-time | PayrollRun CRUD, process payroll, approve |
| useTimeEntries | lib/hooks/useTimeEntries.ts | CRUD + real-time | Clock in/out, manual entries |
| useTimesheets | lib/hooks/useTimesheets.ts | CRUD + real-time | Weekly timesheet summaries |
| useAvailability | lib/hooks/useAvailability.ts | CRUD + real-time | Team availability/scheduling |

### Pages
| Route | File | Notes |
|-------|------|-------|
| /dashboard/payroll | app/dashboard/payroll/page.tsx | Payroll runs, processing |
| /dashboard/team | app/dashboard/team/page.tsx | Team member list, roles |
| /dashboard/timesheets | app/dashboard/timesheets/page.tsx | Timesheet management |

### Components
| Component | File | Notes |
|-----------|------|-------|
| TeamContent | components/team/TeamContent.tsx | Team member cards, roles |
| PayrollRunCard | components/payroll/PayrollRunCard.tsx | Payroll run summary |
| TimesheetTable | components/timesheets/TimesheetTable.tsx | Weekly timesheet grid |

---

## What Exists vs What's Missing

### Already Built
- [x] PayrollRun CRUD with status workflow (draft → processing → approved → paid)
- [x] TimeEntry clock in/out with GPS
- [x] Basic hourly rate per team member
- [x] Timesheet weekly summaries

### Needs to be Created
- [ ] OT calculation engine: Auto-calculate overtime (>40hrs/week = 1.5x, >60hrs = 2x)
- [ ] PTO/vacation tracking: Accrual rates, balance, request/approve workflow
- [ ] Certification tracker: License types, expiry dates, renewal alerts
- [ ] Team member detail page: Profile, certs, PTO balance, payroll history

### Needs Modification
- [ ] usePayroll.ts — Add OT calculation to payroll processing
- [ ] useTimeEntries.ts — Add weekly hour totals for OT detection
- [ ] TeamContent.tsx — Add certification badges, PTO balance display
- [ ] types/index.ts — Add PTO, Certification types

---

## Files to Create

| # | File Path | Purpose | Pattern to Follow |
|---|-----------|---------|-------------------|
| 1 | lib/utils/overtime-calculator.ts | OT calculation: weekly hours → regular/OT/double-OT splits | Pure function |
| 2 | lib/hooks/usePTO.ts | PTO tracking: accrual, balance, requests, approvals | usePayroll.ts pattern |
| 3 | lib/hooks/useCertifications.ts | Certification/license tracking with expiry alerts | useSafety.ts pattern |
| 4 | components/team/CertificationCard.tsx | Certification display with expiry warning | Card pattern |
| 5 | components/team/PTOTracker.tsx | PTO balance, accrual rate, request history | StatsGrid pattern |
| 6 | components/payroll/OvertimeSummary.tsx | OT breakdown per employee in payroll run | Table pattern |
| 7 | app/dashboard/team/[id]/page.tsx | Team member detail page | Project detail pattern |

## Files to Modify

| # | File Path | What Changes |
|---|-----------|-------------|
| 1 | types/index.ts | Add PTORequest, PTOBalance, Certification, OvertimeConfig types |
| 2 | lib/hooks/usePayroll.ts | Integrate OT calculator in processPayroll |
| 3 | lib/hooks/useTimeEntries.ts | Add getWeeklyHours helper |
| 4 | components/team/TeamContent.tsx | Show cert badges, PTO balance |
| 5 | app/dashboard/payroll/page.tsx | Show OT summary section |
| 6 | app/dashboard/team/page.tsx | Link to team member detail |

---

## Parallel Work Plan

### Batch 1 (No Dependencies)
| Agent | Task | Files | Est. Tokens |
|-------|------|-------|-------------|
| Agent 1 | Build OT calculator + integrate in payroll | overtime-calculator.ts, usePayroll.ts, OvertimeSummary.tsx | ~25k |
| Agent 2 | Build PTO hook + tracker component | usePTO.ts, PTOTracker.tsx, types | ~25k |
| Agent 3 | Build certifications hook + card + team detail page | useCertifications.ts, CertificationCard.tsx, team/[id]/page.tsx | ~25k |

### Batch 2 (Integration)
| Agent | Task | Files | Est. Tokens |
|-------|------|-------|-------------|
| Agent 4 | Wire into existing pages, add Firestore rules | team page, payroll page, firestore.rules | ~20k |

---

## Acceptance Criteria

- [ ] OT auto-calculated: >40hrs/week at 1.5x rate
- [ ] PTO balance tracked per employee with accrual
- [ ] PTO request/approve workflow functional
- [ ] Certifications tracked with expiry dates
- [ ] Expiry alerts at 30/60/90 days before
- [ ] Team member detail page shows profile, certs, PTO, payroll history
- [ ] npx tsc --noEmit passes

---

## Estimated Token Budget

| Phase | Tokens |
|-------|--------|
| Batch 1 (3 agents) | ~75k |
| Batch 2 (integration) | ~20k |
| Testing + fixes | ~15k |
| **Total** | **~110k** |
