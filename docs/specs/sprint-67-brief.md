# Sprint 67: Financial Intelligence (BI Dashboards) — Implementation Brief

> **Generated:** 2026-02-05
> **Generated By:** Scoping Sprint 66
> **Spec:** `docs/specs/EPIC-08-BI-DASHBOARDS.md`
> **Status:** Ready for Implementation (skip plan mode)

---

## Existing Infrastructure

### Types
| Type/Interface | File | Lines | Notes |
|---------------|------|-------|-------|
| ProjectProfitability | types/index.ts | 1305-1360 | Complete — all margin/cost/revenue fields |
| JobCostEntry | types/index.ts | 1246-1298 | Complete — individual cost records |
| CostCategory | types/index.ts | 1222-1229 | 7 categories defined |
| Invoice | types/index.ts | ~1710-1800 | Complete — invoicing fields |
| Estimate | types/index.ts | ~2100-2350 | Complete — pipeline data |
| Expense | types/index.ts | ~1470-1589 | Complete — expense tracking |

### Hooks
| Hook | File | Pattern | Notes |
|------|------|---------|-------|
| useOrgJobCosting | lib/hooks/useJobCosting.ts | Real-time + aggregation | Returns profitabilityData[] + summary |
| useProjectProfitability | lib/hooks/useJobCosting.ts | Real-time | Single project profitability |
| useInvoices | lib/hooks/useInvoices.ts | CRUD + real-time | Revenue data, filtering, stats |
| useEstimates | lib/hooks/useEstimates.ts | CRUD + real-time | Pipeline value data |
| useProjects | lib/hooks/useProjects.ts | CRUD + real-time | Active project counts |
| useExpenses | lib/hooks/useExpenses.ts | CRUD + real-time | Expense data with category breakdown |

### Pages
| Route | File | Notes |
|-------|------|-------|
| /dashboard | app/dashboard/page.tsx | Main dashboard — KPI card patterns |
| /dashboard/finances | app/dashboard/finances/page.tsx | 752 lines — existing financial overview |
| /dashboard/intelligence | app/dashboard/intelligence/page.tsx | Exists — currently material price intelligence |

### Components
| Component | File | Notes |
|-----------|------|-------|
| MarginMeter | components/finances/MarginMeter.tsx | Sprint 65 — margin visualization bar |
| JobCostingSummary | components/finances/JobCostingSummary.tsx | 469 lines — project profitability table |
| LineChartCard | components/charts/LineChartCard.tsx | Recharts line chart wrapper |
| BarChartCard | components/charts/BarChartCard.tsx | Recharts bar chart wrapper |
| PieChartCard | components/charts/PieChartCard.tsx | Recharts pie chart wrapper |
| BudgetComparisonChart | components/charts/BudgetComparisonChart.tsx | Budget vs actual |
| ChartTooltip | components/charts/ChartTooltip.tsx | Shared tooltip |
| MaterialPriceWidget | components/intelligence/MaterialPriceWidget.tsx | Existing intelligence component |
| InsightCard | components/intelligence/InsightCard.tsx | General insight display |

### Cloud Functions
| Function | File | Trigger | Notes |
|----------|------|---------|-------|
| onTimeEntryWrite | functions/src/job-costing/index.ts | Firestore write | Recalculates profitability |
| onExpenseWrite | functions/src/job-costing/index.ts | Firestore write | Recalculates profitability |

### Firestore Collections
| Collection | Path | Notes |
|------------|------|-------|
| projectProfitability | organizations/{orgId}/projectProfitability/{projectId} | Auto-populated by Cloud Functions |
| invoices | organizations/{orgId}/invoices OR top-level invoices | Revenue data |
| expenses | organizations/{orgId}/expenses | Cost data |
| estimates | organizations/{orgId}/estimates OR top-level estimates | Pipeline data |

### Dependencies
- `recharts@^3.7.0` — already installed
- `date-fns@^4.1.0` — already installed

---

## What Exists vs What's Missing

### Already Built
- [x] All data hooks (invoices, expenses, projects, profitability)
- [x] Recharts chart library fully integrated with wrapper components
- [x] Finance KPI cards and MarginMeter
- [x] Job costing data auto-population (Cloud Functions)
- [x] Budget utility functions (budget-utils.ts)
- [x] Existing finances page with revenue/expense overview
- [x] Permission framework for finance operations

### Needs to be Created
- [ ] **Company Overview Dashboard** ("The Pulse") — Revenue/Margin MTD/YTD, pipeline, AR
- [ ] **Revenue Trend Chart** — 6-month line chart from invoice data
- [ ] **Margin Trend Chart** — 6-month line chart from profitability data
- [ ] **Project Profitability Leaderboard** — Sortable table with RAG status
- [ ] **Cash Flow Runway** — AR aging chart + cash projection
- [ ] **useCompanyStats hook** — Aggregates org-wide financial metrics
- [ ] **stats/company_daily Cloud Function** — Optional daily snapshot for trend data

### Needs Modification
- [ ] `/dashboard/intelligence/page.tsx` — Replace or expand with BI dashboards
- [ ] Sidebar navigation — Rename/update Intelligence link if needed

---

## Files to Create

| # | File Path | Purpose | Pattern to Follow |
|---|-----------|---------|-------------------|
| 1 | components/intelligence/CompanyOverviewDashboard.tsx | Revenue/Margin/Pipeline/AR KPI cards + trend charts | See finances/page.tsx KPI section |
| 2 | components/intelligence/ProjectProfitabilityLeaderboard.tsx | Sortable table with RAG status colors | See JobCostingSummary.tsx |
| 3 | components/intelligence/CashFlowRunwayDashboard.tsx | AR aging chart + cash projection | See BarChartCard.tsx |
| 4 | lib/hooks/useCompanyStats.ts | Aggregates invoices, estimates, profitability for org-wide stats | See useOrgJobCosting.ts |

## Files to Modify

| # | File Path | What Changes |
|---|-----------|-------------|
| 1 | app/dashboard/intelligence/page.tsx | Replace with 3-dashboard BI layout (tabs or sections) |
| 2 | components/ui/AppShell.tsx | Verify Intelligence link is prominent in sidebar |

---

## Patterns to Follow

### Hook Pattern
```
Reference: lib/hooks/useJobCosting.ts (useOrgJobCosting)
- Uses onSnapshot for real-time
- Returns {data, summary, loading, error, refresh}
- useMemo for aggregation calculations
- Early return if !orgId
```

### Chart Pattern
```
Reference: components/charts/LineChartCard.tsx
- Accept: title, data[], dataKeys[], xAxisKey, valueFormatter
- ResponsiveContainer with height
- Recharts: LineChart, XAxis, YAxis, Tooltip, Legend
```

### Dashboard Layout Pattern
```
Reference: app/dashboard/finances/page.tsx
- PageHeader with title
- useAuth() + role check (OWNER/PM only)
- Parallel data fetches
- Grid: grid-cols-1 lg:grid-cols-2 xl:grid-cols-3
- Card wrapper for each section
```

### RAG Status Pattern
```typescript
function getRAGColor(margin: number): string {
  if (margin > 25) return 'bg-green-100 text-green-700';  // Green
  if (margin >= 15) return 'bg-yellow-100 text-yellow-700'; // Yellow
  return 'bg-red-100 text-red-700'; // Red
}
```

---

## Firestore Rules Needed

No new rules needed — `projectProfitability` already has rules. If `stats/company_daily` is added:

```javascript
match /organizations/{orgId}/companyStats/{date} {
  allow read: if isSameOrg(orgId);
  allow write: if false; // Server-only (Cloud Function)
}
```

---

## Parallel Work Plan

### Batch 1 (No Dependencies)
| Agent | Task | Files | Est. Tokens |
|-------|------|-------|-------------|
| Feature Agent 1 | Build useCompanyStats hook | lib/hooks/useCompanyStats.ts | ~15k |
| Feature Agent 2 | Build CompanyOverviewDashboard | components/intelligence/CompanyOverviewDashboard.tsx | ~20k |
| Feature Agent 3 | Build ProjectProfitabilityLeaderboard | components/intelligence/ProjectProfitabilityLeaderboard.tsx | ~20k |

### Batch 2 (Depends on Batch 1)
| Agent | Task | Files | Est. Tokens |
|-------|------|-------|-------------|
| Feature Agent 1 | Build CashFlowRunwayDashboard | components/intelligence/CashFlowRunwayDashboard.tsx | ~20k |
| Feature Agent 2 | Assemble intelligence/page.tsx with all 3 dashboards | app/dashboard/intelligence/page.tsx | ~15k |

### Batch 3 (Integration)
| Agent | Task | Files | Est. Tokens |
|-------|------|-------|-------------|
| Integration | Wire navigation, verify permissions, tsc check | Multiple | ~10k |

---

## Acceptance Criteria (from spec)

- [ ] "Intelligence" tab visible in sidebar (already exists, may need renaming)
- [ ] Company Overview loads < 2s
- [ ] Revenue/Margin numbers match sum of individual projects
- [ ] Project Profitability table sortable with RAG status
- [ ] AR aging chart shows 0-30, 31-60, 61-90, 90+ day buckets
- [ ] Mobile view: stacked cards instead of complex tables
- [ ] Only OWNER/PM roles can access
- [ ] No TypeScript errors — `npx tsc --noEmit` passes

---

## Decision Log

| Decision | Rationale | Alternative Considered |
|----------|-----------|----------------------|
| Calculate trends from invoice history rather than stats collection | Avoids new Cloud Function + collection; sufficient for MVP | Daily snapshot Cloud Function (defer to later) |
| Reuse existing chart components (LineChartCard, BarChartCard) | Already built and tested with Recharts | Custom chart components |
| Build as 3 sections on one page (not 3 separate pages) | Simpler navigation, "single pane of glass" | Tab-based or separate routes |
| RAG thresholds: >25% green, 15-25% yellow, <15% red | Per spec; matches industry norms | Configurable per-org thresholds (defer) |

---

## Estimated Token Budget

| Phase | Tokens | Notes |
|-------|--------|-------|
| Reading this brief | ~5k | Replaces 150-200k Explore |
| Implementation | ~80-100k | 4 new files + 2 modified |
| Testing + fixes | ~20-30k | TypeScript check, integration |
| **Total** | **~105-135k** | **vs ~300-400k without brief** |
