# Sprint 69: Subcontractor Invoice Management (AP Automation MVP) — Implementation Brief

> **Generated:** 2026-02-05
> **Generated By:** Scoping Sprint 66
> **Spec:** None (derived from strategic plan + backlog analysis)
> **Status:** Ready for Implementation (skip plan mode)

---

## Why This Sprint

**Analysis of remaining backlog priorities:**
- Phases 1-5: Complete (infrastructure, bugs, stability, enhancements)
- Sprint 65: Job Costing Engine (profitability tracking) — complete
- Sprint 67: BI Dashboards (financial intelligence) — scoped
- Sprint 68: Expense OCR (receipt automation) — scoped
- **Gap:** No Accounts Payable (AP) workflow for subcontractor invoices

**Strategic alignment:** The strategic plan emphasizes financial operations. Job costing (Sprint 65) tracks costs, BI dashboards (Sprint 67) visualize them, expense OCR (Sprint 68) automates input — but subcontractor payments (often 40-60% of project costs) have no dedicated workflow.

---

## Existing Infrastructure

### Types
| Type/Interface | File | Lines | Notes |
|---------------|------|-------|-------|
| Subcontractor types | types/index.ts | ~1231-1390 | Subcontractor, Bid interfaces exist |
| Invoice | types/index.ts | ~1710-1800 | Client-facing invoice type (AR, not AP) |
| Expense | types/index.ts | ~1470-1589 | Expense tracking with categories |
| CostCategory | types/index.ts | 1222-1229 | Includes labor_subcontractor |

### Hooks
| Hook | File | Pattern | Notes |
|------|------|---------|-------|
| useSubcontractors | lib/hooks/useSubcontractors.ts | CRUD + real-time | Subcontractor management |
| useBids | lib/hooks/useBids.ts | CRUD + real-time | Bid tracking per project |
| useInvoices | lib/hooks/useInvoices.ts | CRUD + real-time | Client invoices (AR) — pattern to follow for AP |
| useExpenses | lib/hooks/useExpenses.ts | CRUD + approval | Approval workflow pattern to reuse |

### Pages
| Route | File | Notes |
|-------|------|-------|
| /dashboard/subcontractors | app/dashboard/subcontractors/page.tsx | Subcontractor directory |
| /dashboard/invoices | app/dashboard/invoices/page.tsx | Client invoicing (AR) |

### Components
| Component | File | Notes |
|-----------|------|-------|
| SubcontractorCard | components/subcontractors/SubcontractorCard.tsx | Sub display card |
| BidList | components/subcontractors/BidList.tsx | Bid management |
| BidFormModal | components/subcontractors/BidFormModal.tsx | Bid entry form |
| ExpenseCard | components/expenses/ExpenseCard.tsx | Approval workflow pattern |
| FormModal | components/ui/FormModal.tsx | Standard modal pattern |

### Cloud Functions
| Function | File | Notes |
|----------|------|-------|
| onExpenseWrite | functions/src/job-costing/index.ts | Recalculates profitability on expense write |
| category-mapping | functions/src/job-costing/category-mapping.ts | Maps sub costs to labor_subcontractor |

### Firestore Collections
| Collection | Path | Notes |
|------------|------|-------|
| subcontractors | organizations/{orgId}/subcontractors | Existing |
| bids | organizations/{orgId}/bids | Existing |
| expenses | organizations/{orgId}/expenses | Could store sub invoices as expenses, but dedicated collection better |
| projectProfitability | organizations/{orgId}/projectProfitability | Auto-updated by Cloud Functions |

---

## What Exists vs What's Missing

### Already Built
- [x] Subcontractor directory and management
- [x] Bid tracking and management
- [x] Expense approval workflow (pattern to reuse)
- [x] Job costing category mapping (labor_subcontractor)
- [x] Profitability auto-recalculation
- [x] Invoice PDF generation (client-side, reusable)
- [x] E-signature system (for lien waivers)
- [x] OCR infrastructure (reusable for sub invoices)

### Needs to be Created
- [ ] **SubcontractorInvoice type** — AP invoice distinct from AR invoice
- [ ] **useSubcontractorInvoices hook** — CRUD + approval workflow
- [ ] **SubcontractorInvoiceForm** — Create/edit AP invoices
- [ ] **InvoiceApprovalCard** — Approval workflow UI
- [ ] **LienWaiverModal** — Waiver request and collection
- [ ] **AP Dashboard page** — Pending approvals, payment queue
- [ ] **Cloud Function: onSubInvoiceWrite** — Trigger profitability recalc when sub invoice approved/paid

### Needs Modification
- [ ] **SubcontractorCard** — Add "View Invoices" link
- [ ] **Dashboard page** — Add "Pending AP Approvals" widget
- [ ] **types/index.ts** — Add SubcontractorInvoice + LienWaiver types
- [ ] **functions/src/index.ts** — Export new AP trigger
- [ ] **Firestore rules** — Add subcontractorInvoices collection rules

---

## Files to Create

| # | File Path | Purpose | Pattern to Follow |
|---|-----------|---------|-------------------|
| 1 | lib/hooks/useSubcontractorInvoices.ts | CRUD + approval workflow for AP invoices | See useExpenses.ts (approval pattern) |
| 2 | components/subcontractors/SubcontractorInvoiceForm.tsx | Create/edit AP invoice | See ExpenseFormModal.tsx |
| 3 | components/subcontractors/InvoiceApprovalCard.tsx | Approval workflow card | See ExpenseCard.tsx |
| 4 | components/subcontractors/LienWaiverModal.tsx | Request/collect lien waivers | See FormModal pattern |
| 5 | app/dashboard/ap-invoicing/page.tsx | AP dashboard with approval queue | See expenses/page.tsx |
| 6 | functions/src/ap-invoicing/index.ts | Cloud Function trigger for sub invoice writes | See job-costing/index.ts |

## Files to Modify

| # | File Path | What Changes |
|---|-----------|-------------|
| 1 | types/index.ts | Add SubcontractorInvoice, LienWaiver types (~80 lines after Subcontractor section) |
| 2 | functions/src/index.ts | Export AP invoicing trigger |
| 3 | components/subcontractors/SubcontractorCard.tsx | Add "Invoices" action link |
| 4 | firestore.rules | Add subcontractorInvoices + lienWaivers collection rules |
| 5 | firestore.indexes.json | Add indexes for AP queries (vendorId+status, projectId+status) |

---

## New Firestore Schema

### subcontractorInvoices collection
```
organizations/{orgId}/subcontractorInvoices/{invoiceId}
{
  vendorId: string;          // ref to subcontractors
  vendorName: string;        // denormalized
  projectId: string;         // ref to projects
  projectName: string;       // denormalized
  invoiceNumber: string;     // vendor's invoice number
  invoiceDate: Date;
  dueDate: Date;
  amount: number;
  description: string;
  lineItems: Array<{
    description: string;
    quantity: number;
    rate: number;
    amount: number;
  }>;
  status: 'draft' | 'submitted' | 'approved' | 'paid' | 'disputed';
  approvedBy?: string;
  approvedAt?: Date;
  paidAt?: Date;
  paymentMethod?: string;
  checkNumber?: string;
  lienWaiverStatus: 'not_required' | 'pending' | 'received';
  lienWaiverId?: string;
  attachmentUrls: string[];   // PDF/image of original invoice
  notes?: string;
  createdAt: Date;
  createdBy: string;
  updatedAt?: Date;
}
```

### lienWaivers collection
```
organizations/{orgId}/lienWaivers/{waiverId}
{
  invoiceId: string;
  vendorId: string;
  vendorName: string;
  projectId: string;
  waiverType: 'conditional' | 'unconditional';
  amount: number;
  requestedAt: Date;
  requestedBy: string;
  signedAt?: Date;
  signatureUrl?: string;     // e-signature file
  status: 'pending' | 'signed' | 'expired';
  createdAt: Date;
}
```

---

## Firestore Rules Needed

```javascript
match /organizations/{orgId}/subcontractorInvoices/{invoiceId} {
  allow read: if isSameOrg(orgId);
  allow create: if isSameOrg(orgId);
  allow update: if isSameOrg(orgId);
  allow delete: if isSameOrg(orgId) && isAdmin();
}

match /organizations/{orgId}/lienWaivers/{waiverId} {
  allow read: if isSameOrg(orgId);
  allow create: if isSameOrg(orgId);
  allow update: if isSameOrg(orgId);
  allow delete: if isSameOrg(orgId) && isAdmin();
}
```

## Firestore Indexes Needed

```json
[
  {
    "collectionGroup": "subcontractorInvoices",
    "queryScope": "COLLECTION",
    "fields": [
      { "fieldPath": "status", "order": "ASCENDING" },
      { "fieldPath": "dueDate", "order": "ASCENDING" }
    ]
  },
  {
    "collectionGroup": "subcontractorInvoices",
    "queryScope": "COLLECTION",
    "fields": [
      { "fieldPath": "vendorId", "order": "ASCENDING" },
      { "fieldPath": "invoiceDate", "order": "DESCENDING" }
    ]
  },
  {
    "collectionGroup": "subcontractorInvoices",
    "queryScope": "COLLECTION",
    "fields": [
      { "fieldPath": "projectId", "order": "ASCENDING" },
      { "fieldPath": "status", "order": "ASCENDING" }
    ]
  }
]
```

---

## Patterns to Follow

### Approval Workflow Pattern
```
Reference: lib/hooks/useExpenses.ts (startReview, approveExpense, rejectExpense)
- Status flow: draft → submitted → approved → paid
- Role check: only PM/OWNER can approve
- Record approvedBy + approvedAt
- Toast notification on status change
```

### Hook Pattern
```
Reference: lib/hooks/useExpenses.ts
- onSnapshot for real-time updates
- Return {invoices, loading, error, createInvoice, updateInvoice, approveInvoice, markPaid}
- Early return if !orgId
- Limit queries
```

### Card Pattern
```
Reference: components/expenses/ExpenseCard.tsx
- Card with status badge
- Amount prominently displayed
- Action buttons based on role + status
- Responsive layout
```

### Cloud Function Pattern
```
Reference: functions/src/job-costing/index.ts
- onDocumentWritten with database: "contractoros"
- Extract orgId from event.params
- Recalculate profitability when invoice marked paid
```

---

## Parallel Work Plan

### Batch 1 (No Dependencies)
| Agent | Task | Files | Est. Tokens |
|-------|------|-------|-------------|
| Feature Agent 1 | Add types to types/index.ts | types/index.ts | ~10k |
| Feature Agent 2 | Build useSubcontractorInvoices hook | lib/hooks/useSubcontractorInvoices.ts | ~20k |
| Database Agent | Add Firestore rules + indexes | firestore.rules, firestore.indexes.json | ~10k |

### Batch 2 (Depends on Batch 1)
| Agent | Task | Files | Est. Tokens |
|-------|------|-------|-------------|
| Feature Agent 1 | Build SubcontractorInvoiceForm + InvoiceApprovalCard | 2 new components | ~25k |
| Feature Agent 2 | Build LienWaiverModal | 1 new component | ~15k |
| Feature Agent 3 | Build AP dashboard page | app/dashboard/ap-invoicing/page.tsx | ~20k |

### Batch 3 (Integration)
| Agent | Task | Files | Est. Tokens |
|-------|------|-------|-------------|
| Cloud Function Agent | Build onSubInvoiceWrite trigger | functions/src/ap-invoicing/ | ~15k |
| Integration Agent | Wire navigation, update SubcontractorCard, tsc check | Multiple | ~15k |

---

## Acceptance Criteria

- [ ] Create/edit subcontractor invoices with line items
- [ ] Approval workflow: submit → approve → paid
- [ ] Lien waiver request and tracking per invoice
- [ ] AP dashboard showing pending approvals, payment queue
- [ ] Filter by vendor, project, status, date range
- [ ] Invoice total auto-calculated from line items
- [ ] Profitability recalculated when sub invoice marked paid
- [ ] SubcontractorCard links to filtered invoice list
- [ ] Only OWNER/PM can approve invoices
- [ ] Mobile-responsive UI
- [ ] No TypeScript errors — `npx tsc --noEmit` passes
- [ ] Firestore rules deployed

---

## Decision Log

| Decision | Rationale | Alternative Considered |
|----------|-----------|----------------------|
| Separate subcontractorInvoices collection (not reuse expenses) | Different schema, workflow, and reporting needs | Store as expenses with vendorType flag |
| Simple approval (PM/OWNER) not multi-level | MVP simplicity; multi-level can be added later | Configurable approval chains |
| Lien waiver tracking (not full e-sign flow) | Track status + store signed document; reuse existing e-sign for actual signing | Build dedicated lien waiver signing flow |
| Cloud Function for profitability update on payment | Keeps profitability data accurate as sub costs are paid | Manual recalculation only |

---

## Estimated Token Budget

| Phase | Tokens | Notes |
|-------|--------|-------|
| Reading this brief | ~5k | Replaces 150-200k Explore |
| Implementation | ~100-130k | 6 new files + 5 modified |
| Cloud Functions | ~20-30k | AP trigger + deploy |
| Testing + fixes | ~25-35k | TypeScript check, rules deploy |
| **Total** | **~150-200k** | **vs ~350-500k without brief** |
