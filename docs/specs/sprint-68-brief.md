# Sprint 68: Expense Automation (OCR) — Implementation Brief

> **Generated:** 2026-02-05
> **Generated By:** Scoping Sprint 66
> **Spec:** (No formal epic — derived from NEXT_PHASE_PLAN.md Sprint 68)
> **Status:** Ready for Implementation (skip plan mode)

---

## Key Finding: OCR Infrastructure Is Already Built

**The core OCR pipeline is COMPLETE and DEPLOYED.** Sprint 68 focus should be on the **display/analytics layer** and **UX polish**, not building OCR from scratch.

---

## Existing Infrastructure

### Cloud Functions
| Function | File | Status | Notes |
|----------|------|--------|-------|
| processReceiptOCR | functions/src/expenses/processReceiptOCR.ts | COMPLETE (739 lines) | Claude Haiku primary, Sonnet fallback. Rate-limited (10/min). Extracts vendor, date, total, tax, category, line items. |

### API Routes
| Route | File | Status | Notes |
|-------|------|--------|-------|
| /api/receipt-ocr | app/api/receipt-ocr/route.ts | COMPLETE (200 lines) | Uses Gemini models. Proxies to avoid CORS. |

### Types
| Type/Interface | File | Notes |
|---------------|------|-------|
| Expense | types/index.ts ~L1470-1589 | Complete with receipt fields |
| ExpenseReceipt | types/index.ts | id, url, thumbnailUrl, fileName, fileSize, mimeType, uploadedAt |
| EXPENSE_CATEGORIES | types/index.ts | 15 categories defined as constants |
| ReceiptOCRResult | components/expenses/ReceiptScanner.ts | OCR result interface (local) |

### Hooks
| Hook | File | Pattern | Notes |
|------|------|---------|-------|
| useExpenses | lib/hooks/useExpenses.ts | CRUD + real-time (655 lines) | Full expense lifecycle: create, update, approve, reject, mark paid. Receipt operations: addReceipt, removeReceipt. |

### Components
| Component | File | Lines | Status | Notes |
|-----------|------|-------|--------|-------|
| ReceiptCaptureButton | components/expenses/ReceiptCaptureButton.tsx | 323 | COMPLETE | Camera + file picker, state machine (idle/preview/scanning/success/error), confidence display |
| ReceiptScanner | components/expenses/ReceiptScanner.ts | 150 | COMPLETE | Core utility calling /api/receipt-ocr, exports scanReceipt() |
| ExpenseFormModal | components/expenses/ExpenseFormModal.tsx | 486 | COMPLETE | Integrates ReceiptCaptureButton, auto-fills form from OCR result, shows "auto-filled" badge |
| ExpenseCard | components/expenses/ExpenseCard.tsx | 623 | COMPLETE | Shows receipt count, approval workflow |
| ExpenseDetailsModal | components/expenses/ExpenseDetailsModal.tsx | 639 | COMPLETE | Full detail view with approval workflow |

### Pages
| Route | File | Notes |
|-------|------|-------|
| /dashboard/expenses | app/dashboard/expenses/page.tsx | Full expense dashboard with pagination, filters, create modal |

### Upload Infrastructure
| Utility | File | Notes |
|---------|------|-------|
| fileToBase64 | lib/firebase/upload-helpers.ts | Converts File to base64 for OCR |
| uploadReceiptImage | lib/firebase/upload-helpers.ts | Uploads to Firebase Storage, auto-compresses to 2048px |

### Firestore Collections
| Collection | Path | Notes |
|------------|------|-------|
| expenses | organizations/{orgId}/expenses/{expenseId} | Includes receipts array |
| ocrLogs | organizations/{orgId}/ocrLogs (written by Cloud Function) | Success/failure, model, confidence, processing time |

### Dependencies (All Installed)
- `@anthropic-ai/sdk@^0.72.1` — Cloud Function OCR
- `@google/generative-ai@^0.24.1` — API route OCR
- `recharts@^3.7.0` — Charts for OCR analytics
- `react-hook-form@^7.56.0` + `zod@^4.3.6` — Form handling

---

## What Exists vs What's Missing

### Already Built
- [x] OCR Cloud Function (Claude Haiku/Sonnet) — production-ready
- [x] API proxy route (Gemini) — working
- [x] Receipt capture UI (camera + file picker)
- [x] Auto-fill from OCR to expense form
- [x] Expense CRUD hook with receipt operations
- [x] Expense dashboard with pagination + filters
- [x] Receipt storage (Firebase Storage)
- [x] Rate limiting (10 req/min)
- [x] OCR logging to Firestore
- [x] Category mapping (Sprint 65)

### Needs to be Created
- [ ] **LineItemsTable** — Display OCR-extracted line items in expense details
- [ ] **ReceiptGallery** — View uploaded receipt images per expense
- [ ] **OCRConfidenceAlert** — Alert for low-confidence results with retry option
- [ ] **useOCRLogs hook** — Query ocrLogs collection for analytics
- [ ] **OCR Analytics dashboard** — Admin view of OCR success rates, confidence distribution

### Needs Modification
- [ ] **ExpenseDetailsModal** — Add line items table + receipt gallery + confidence alert
- [ ] **ExpenseFormModal** — Show line items from OCR before submission
- [ ] **types/index.ts** — Add optional OCR metadata fields to Expense type
- [ ] **Expense page** — Add OCR logs link for admins

---

## Files to Create

| # | File Path | Purpose | Pattern to Follow |
|---|-----------|---------|-------------------|
| 1 | components/expenses/LineItemsTable.tsx | Display OCR-extracted line items | See DataTable component |
| 2 | components/expenses/ReceiptGallery.tsx | View uploaded receipt images | See PhotoGallery component |
| 3 | components/expenses/OCRConfidenceAlert.tsx | Low-confidence alert with retry | See SectionErrorBoundary |
| 4 | lib/hooks/useOCRLogs.ts | Query ocrLogs collection | See useExpenses.ts |
| 5 | app/dashboard/expenses/ocr-analytics/page.tsx | OCR performance dashboard | See finances/page.tsx |

## Files to Modify

| # | File Path | What Changes |
|---|-----------|-------------|
| 1 | components/expenses/ExpenseDetailsModal.tsx | Add LineItemsTable, ReceiptGallery, OCRConfidenceAlert |
| 2 | components/expenses/ExpenseFormModal.tsx | Show line items from OCR in read-only before save |
| 3 | types/index.ts | Add ocrConfidence?, ocrModel?, ocrProcessingTime?, lineItems? to Expense |
| 4 | app/dashboard/expenses/page.tsx | Add OCR analytics link for admins |

---

## Patterns to Follow

### Confidence Display Pattern
```
Reference: components/expenses/ReceiptScanner.ts (getConfidenceDisplay)
- >= 0.9: "High confidence" (green)
- >= 0.7: "Good confidence" (blue)
- >= 0.5: "Medium confidence" (yellow)
- < 0.5: "Low confidence - please verify" (orange)
```

### Receipt Capture State Machine
```
Reference: components/expenses/ReceiptCaptureButton.tsx
- idle → preview → scanning → success/error
- Show image preview before OCR
- Retry on error
- Auto-fill callback on success
```

### Form Auto-Fill Pattern
```
Reference: components/expenses/ExpenseFormModal.tsx
- Use setValue() with shouldValidate: true
- Show visual badge when OCR fills fields
- Allow manual override
```

---

## Firestore Rules Needed

```javascript
// ocrLogs — admin read-only
match /organizations/{orgId}/ocrLogs/{logId} {
  allow read: if isSameOrg(orgId) && isAdmin();
  allow write: if false; // Server-only (Cloud Function writes)
}
```

---

## Parallel Work Plan

### Batch 1 (No Dependencies)
| Agent | Task | Files | Est. Tokens |
|-------|------|-------|-------------|
| Feature Agent 1 | Build LineItemsTable + ReceiptGallery | 2 new components | ~20k |
| Feature Agent 2 | Build OCRConfidenceAlert + useOCRLogs hook | 1 component + 1 hook | ~15k |
| Feature Agent 3 | Add OCR fields to Expense type | types/index.ts | ~5k |

### Batch 2 (Depends on Batch 1)
| Agent | Task | Files | Est. Tokens |
|-------|------|-------|-------------|
| Feature Agent 1 | Integrate into ExpenseDetailsModal + ExpenseFormModal | 2 modified files | ~20k |
| Feature Agent 2 | Build OCR analytics page | app/dashboard/expenses/ocr-analytics/page.tsx | ~20k |

### Batch 3 (Integration)
| Agent | Task | Files | Est. Tokens |
|-------|------|-------|-------------|
| Integration | Wire navigation, test full workflow, tsc check | Multiple | ~15k |

---

## Acceptance Criteria

### Core (MUST HAVE)
- [ ] Receipt capture works on mobile with camera
- [ ] OCR extracts vendor, date, total, category correctly (>80% of receipts)
- [ ] Form auto-fills with confidence >= 0.7
- [ ] Line items displayed in expense details (when available from OCR)
- [ ] Receipt images viewable per expense
- [ ] Confidence indicator visible to user
- [ ] No TypeScript errors

### Analytics (NICE TO HAVE)
- [ ] OCR logs dashboard with success rate, avg confidence, processing times
- [ ] Charts showing Haiku vs Sonnet usage breakdown

### Mobile (MUST HAVE)
- [ ] Camera capture works on iOS Safari and Android Chrome
- [ ] Image preview shows before OCR processing
- [ ] Fallback to file picker if camera not available

---

## Decision Log

| Decision | Rationale | Alternative Considered |
|----------|-----------|----------------------|
| Focus on display layer (not rebuilding OCR) | OCR pipeline already complete and deployed | Rebuild OCR with different provider |
| Keep dual-model approach (Cloud Function = Claude, API route = Gemini) | Both working; different cost/latency profiles | Standardize on one model |
| Add OCR metadata to Expense type as optional fields | Backward compatible, doesn't break existing expenses | Separate ocrResults collection |
| LineItemsTable as separate component | Reusable for AP invoices (Sprint 69) | Inline in ExpenseDetailsModal |

---

## Estimated Token Budget

| Phase | Tokens | Notes |
|-------|--------|-------|
| Reading this brief | ~5k | Replaces 150-200k Explore |
| Implementation | ~60-80k | 5 new files + 4 modified |
| Testing + fixes | ~15-25k | TypeScript check, mobile testing |
| **Total** | **~80-110k** | **vs ~250-350k without brief** |

---

## Known Issues

1. **API Route / Cloud Function model mismatch** — Cloud Function uses Claude, API route uses Gemini. Both work but results may differ slightly.
2. **Receipt images not auto-captured during OCR** — Users upload receipt images separately from OCR scan. Could be streamlined.
3. **Confidence threshold hardcoded at 0.7** — Could be configurable per org in settings.
