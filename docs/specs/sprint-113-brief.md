# Sprint 113: Console Cleanup & Structured Logging — Implementation Brief

> **Generated:** 2026-02-06
> **Generated By:** Roadmap Planning Session
> **Status:** Ready for Implementation (skip plan mode)
> **Priority:** P2 | **Hours:** 6-8

---

## Overview

Replace ~1,066 console statements across the app with a structured logger (`lib/utils/logger.ts`). The logger supports dev vs prod modes, log levels, context tags, and a Sentry-ready error reporting interface. Target: fewer than 50 console statements remaining.

---

## Existing Infrastructure

### Utility Files
| File | Path | Status |
|------|------|--------|
| error-handler.ts | apps/web/lib/utils/error-handler.ts | EXISTS |
| formatters.ts | apps/web/lib/utils/formatters.ts | EXISTS |
| Toast.tsx | apps/web/components/ui/Toast.tsx | EXISTS |

### Console Statement Distribution (~1,066 total in apps/web)

| Directory | Count | Key Files |
|-----------|-------|-----------|
| lib/hooks/ | ~350 | useProjectPhotos (21), useAssistant (17), useTimeEntries (15), usePayments (13), useExpenses (13) |
| components/ | ~200 | TeamContent (8), TimeClockWidget (4), PendingPhotosGrid (5) |
| lib/services/ | ~30 | weather.ts (13), service-worker (13) |
| lib/security/ | ~35 | session-manager (8), security-checklist (7), data-retention (7) |
| lib/assistant/ | ~25 | server-context-loader (8), model adapters (3 each) |
| lib/integrations/ | ~20 | google-business (11), quickbooks (6) |
| app/ pages | ~150 | login (6), field/page (8), sub pages (15), api routes (40+) |

Cloud Functions (functions/src) — ~152 total.

---

## What Exists vs What's Missing

### Already Built
- lib/utils/error-handler.ts — Basic error utility
- components/ui/Toast.tsx — User-facing toast notifications
- lib/security/audit-logger.ts — Audit trail logging (keep separate)

### Needs to be Created
- `lib/utils/logger.ts` — Structured logger with levels, context, dev/prod modes
- `functions/src/utils/logger.ts` — Server-side structured logger for Cloud Functions

### Needs Modification
- ~200 files across apps/web/ — Replace console calls with logger
- ~16 files across functions/src/ — Replace console calls with server logger

---

## Files to Create

| # | File Path | Purpose | Pattern to Follow |
|---|-----------|---------|-------------------|
| 1 | apps/web/lib/utils/logger.ts | Client-side structured logger | See spec below |
| 2 | functions/src/utils/logger.ts | Server-side structured logger | Mirror client API |

### Logger Spec

```typescript
type LogLevel = 'debug' | 'info' | 'warn' | 'error';

interface LogContext {
  module?: string;
  action?: string;
  userId?: string;
  orgId?: string;
  projectId?: string;
  [key: string]: unknown;
}
```

Environment-aware behavior:
- Development: console output with colors and context
- Production: suppress debug/info, errors route to Sentry-ready interface
- Configurable via LOG_LEVEL env var

Exports: `logger.debug(msg, ctx?)`, `logger.info(msg, ctx?)`, `logger.warn(msg, ctx?)`, `logger.error(msg, err?, ctx?)`, `logger.captureException(err, ctx?)`

### Replacement Rules

| Current Pattern | Replacement |
|-----------------|-------------|
| console.log debug message | DELETE |
| console.log "Fetching X" | DELETE |
| console.error in catch block | logger.error with module context |
| console.warn deprecation | logger.warn with module context |
| console.log data dump | DELETE |

### Files to EXCLUDE from cleanup

| File | Reason |
|------|--------|
| scripts/seeders/demoData.ts | Seed scripts need console output |
| scripts/seed-demo/** | Seed scripts need console output |
| __tests__/** | Test files can use console |
| lib/utils/logger.ts | Logger itself uses console internally |

---

## Files to Modify (Top 15 by Count)

| # | File Path | Console Count |
|---|-----------|---------------|
| 1 | lib/hooks/useProjectPhotos.ts | 21 |
| 2 | lib/hooks/useAssistant.ts | 17 |
| 3 | lib/hooks/useTimeEntries.ts | 15 |
| 4 | lib/hooks/usePayments.ts | 13 |
| 5 | lib/hooks/useExpenses.ts | 13 |
| 6 | lib/hooks/useTasks.ts | 12 |
| 7 | lib/hooks/useServiceWorker.ts | 11 |
| 8 | lib/hooks/useSubcontractorInvoices.ts | 10 |
| 9 | lib/hooks/useSms.ts | 10 |
| 10 | lib/services/weather.ts | 13 |
| 11 | lib/security/session-manager.ts | 8 |
| 12 | lib/security/security-checklist.ts | 7 |
| 13 | lib/security/data-retention.ts | 7 |
| 14 | lib/assistant/server-context-loader.ts | 8 |
| 15+ | ~185 additional files | 1-6 each |

---

## Patterns to Follow

### Hook Error Handling (BEFORE)
```typescript
} catch (error) {
  console.error('Failed to load expenses:', error);
  setError(error instanceof Error ? error : new Error('Unknown'));
}
```

### Hook Error Handling (AFTER)
```typescript
import { logger } from '@/lib/utils/logger';

} catch (error) {
  logger.error('Failed to load expenses', error, { module: 'useExpenses', action: 'fetch' });
  setError(error instanceof Error ? error : new Error('Unknown'));
}
```

---

## Firestore Rules / Indexes Needed

None — code quality refactor only.

---

## Parallel Work Plan

### Batch 1 (No Dependencies)

| Agent | Type | Task | Files Owned |
|-------|------|------|-------------|
| Agent 1 | general-purpose | Create lib/utils/logger.ts + replace console in lib/hooks/** (~350 calls) | lib/utils/logger.ts, lib/hooks/*.ts |
| Agent 2 | general-purpose | Replace console in components/** (~200 calls) | components/**/*.tsx |
| Agent 3 | general-purpose | Replace console in app/** pages + API routes (~150 calls) | app/**/*.tsx, app/api/**/*.ts |
| Agent 4 | general-purpose | Create functions/src/utils/logger.ts + replace console in functions/src/** (~152 calls) | functions/src/**/*.ts |

### Batch 2 (Depends on Batch 1)

| Agent | Type | Task | Files Owned |
|-------|------|------|-------------|
| Agent 5 | general-purpose | Replace console in lib/services/**, lib/security/**, lib/assistant/**, lib/integrations/** (~110 calls) | lib/services/**, lib/security/**, lib/assistant/**, lib/integrations/** |
| Main Session | — | Run npx tsc --noEmit, verify console count below 50, update MODULE_REGISTRY.md | Docs |

---

## Acceptance Criteria

- [ ] lib/utils/logger.ts created with log levels, context tags, dev/prod mode
- [ ] functions/src/utils/logger.ts created for Cloud Functions
- [ ] Console statements in apps/web/ reduced from ~1,066 to below 50 (excluding scripts/tests)
- [ ] Console statements in functions/src/ reduced from ~152 to 0
- [ ] All catch blocks use logger.error() with module context
- [ ] TypeScript: 0 errors (npx tsc --noEmit)
- [ ] Logger suppresses debug/info in production
- [ ] MODULE_REGISTRY.md updated with logger utility entry

---

## Estimated Token Budget

| Task | Tokens |
|------|--------|
| Read MODULE_REGISTRY.md | 5,000 |
| Create logger files | 3,000 |
| Replace in hooks (~40 files) | 40,000 |
| Replace in components (~50 files) | 30,000 |
| Replace in app/ pages (~30 files) | 25,000 |
| Replace in lib/ remaining (~25 files) | 20,000 |
| Replace in functions/ (~16 files) | 15,000 |
| Type check + verification | 3,000 |
| **Total** | **~141,000** |
