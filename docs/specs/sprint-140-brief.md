# Sprint 140: Performance Audit & Optimization Mega-Sprint — Implementation Brief

> **Generated:** 2026-02-06
> **Generated By:** Roadmap Planning Session (Phase 22: Client Experience)
> **Status:** Ready for Implementation (skip plan mode)
> **Priority:** P1 | **Hours:** 10-14
> **Note:** This sprint runs ABSOLUTELY LAST — after all features are built.

---

## Overview

End-of-roadmap optimization pass. Bundle analysis, Firestore query optimization, image pipeline, Server Component migration, caching strategy, Core Web Vitals targets, and memory leak audit.

---

## Scope

### Bundle Analysis & Code Splitting
- Analyze bundle with `next build --analyze`
- Identify chunks > 100KB
- Code-split below-fold components with dynamic imports
- Lazy-load heavy libraries (@react-pdf/renderer, chart libraries)
- Target: main chunk < 400KB

### Firestore Optimization
- Audit ALL queries for missing indexes
- Add `limit()` where missing
- Compound queries where possible
- Verify every compound query has matching index
- Target: zero "requires index" errors

### Image Pipeline
- Verify all user-uploaded images are WebP-optimized
- Ensure proper sizing with `width`/`height` on all `<Image>` components
- Lazy-load below-fold images
- Target: no unoptimized images

### Server Component Migration
- Convert data-fetching pages to React Server Components where possible
- Keep client interactivity in 'use client' components
- Reduce client-side JavaScript

### Caching Strategy
- Configure Firestore cache settings
- Add appropriate `revalidate` values to Server Components
- Consider SWR/React Query for API responses

### Core Web Vitals
- LCP < 2.5s
- FID < 100ms
- CLS < 0.1
- Run Lighthouse on 10 key pages

### Memory Leak Audit
- Profile with React DevTools
- Fix any growing subscriptions
- Verify all useEffect cleanups

---

## Parallel Work Plan

### Batch 1 (All Independent)
| Agent | Task | Est. Tokens |
|-------|------|-------------|
| Agent 1 | Bundle analysis + code splitting | ~30k |
| Agent 2 | Firestore query audit + index optimization | ~30k |
| Agent 3 | Image pipeline optimization | ~20k |
| Agent 4 | Memory leak audit + useEffect cleanup | ~25k |

### Batch 2 (After Batch 1)
| Agent | Task | Est. Tokens |
|-------|------|-------------|
| Agent 1 | Server Component migration (top 10 pages) | ~30k |
| Agent 2 | Caching strategy implementation | ~20k |

### Batch 3 (Verification)
| Agent | Task | Est. Tokens |
|-------|------|-------------|
| Bash | Lighthouse audit on 10 key pages | ~10k |
| Bash | Build size verification | ~5k |
| Bash | Full test suite run | ~5k |

---

## Acceptance Criteria

- [ ] Lighthouse scores > 85 on all 10 key pages
- [ ] Main bundle chunk < 400KB
- [ ] Dashboard loads in < 2s
- [ ] No Firestore "requires index" errors
- [ ] LCP < 2.5s on all measured pages
- [ ] CLS < 0.1 on all measured pages
- [ ] No memory leaks detected in React DevTools profiling
- [ ] All images use next/image with proper dimensions
- [ ] npx tsc --noEmit passes
- [ ] All tests pass

---

## Estimated Token Budget: ~175k
